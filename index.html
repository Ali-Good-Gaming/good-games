<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sapper Ultimate Elite | ALI_GOOD_GAMING</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ================================================================
           1. –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –¶–í–ï–¢–û–í –ò –¢–ï–ú (CSS VARIABLES)
           ================================================================
        */
        :root {
            /* –ë–∞–∑–æ–≤—ã–π —Ñ–æ–Ω: –ì–ª—É–±–æ–∫–∏–π –º–∞—Ç–æ–≤—ã–π —Å–∏–Ω–µ-—á–µ—Ä–Ω—ã–π (–¥–ª—è –∏–¥–µ–∞–ª—å–Ω–æ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏) */
            --bg-body: #0a0b10;
            
            /* –¶–≤–µ—Ç–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ (–ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ) */
            --bg-card: #12141d;
            --bg-board: #050608;
            
            /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç: Cyber Red / Pink */
            --primary: #e94560;
            --primary-glow: rgba(233, 69, 96, 0.5);
            --primary-dark: #951c30;

            /* –¢–µ–∫—Å—Ç */
            --text-main: #ffffff;
            --text-dim: #71758e;
            
            /* –Ø—á–µ–π–∫–∏ */
            --cell-idle: #1c1f2b;
            --cell-border: #2d3142;
            --cell-hover: #363b53;

            /* –®—Ä–∏—Ñ—Ç—ã */
            --font-display: 'Orbitron', sans-serif;
            --font-main: 'Montserrat', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* –¢–∞–π–º–∏–Ω–≥–∏ */
            --trans-fast: 0.15s ease;
            --trans-norm: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* –°–∏—Å—Ç–µ–º—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ç–µ–º */
        [data-theme="ocean"] { --primary: #00d2ff; --primary-glow: rgba(0, 210, 255, 0.5); --primary-dark: #0086a3; }
        [data-theme="emerald"] { --primary: #00ff88; --primary-glow: rgba(0, 255, 136, 0.5); --primary-dark: #009e54; }
        [data-theme="gold"] { --primary: #f1c40f; --primary-glow: rgba(241, 196, 15, 0.5); --primary-dark: #a38500; }
        [data-theme="blood"] { --primary: #ff0040; --primary-glow: rgba(255, 0, 64, 0.5); --primary-dark: #9e0027; }

        /* ================================================================
           2. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò (RESET & BODY)
           ================================================================
        */
        * {
            box-sizing: border-box;
            margin: 0; padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–æ–Ω (Canvas) */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app-root {
            position: relative;
            z-index: 10;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
        }

        /* ================================================================
           3. –ö–û–ú–ü–û–ù–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê (UI)
           ================================================================
        */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 650px;
            animation: screenEntry 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        .screen.active { display: flex; }

        @keyframes screenEntry {
            from { opacity: 0; transform: scale(0.95) translateY(30px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* –õ–æ–≥–æ—Ç–∏–ø –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥ */
        .logo-group {
            text-align: center;
            margin-bottom: 40px;
        }

        .main-logo {
            font-family: var(--font-display);
            font-size: clamp(3rem, 12vw, 6rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -2px;
            background: linear-gradient(to bottom, #fff 30%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px var(--primary-glow));
            line-height: 0.85;
        }

        .brand-sub {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            letter-spacing: 10px;
            color: var(--primary);
            text-transform: uppercase;
            margin-top: 15px;
            font-weight: 700;
            opacity: 0.9;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .menu-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 85%;
        }

        .action-btn {
            background: var(--bg-card);
            border: 1px solid var(--cell-border);
            color: #fff;
            padding: 20px 30px;
            font-family: var(--font-display);
            font-size: 1rem;
            border-radius: 16px;
            cursor: pointer;
            transition: var(--trans-norm);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }

        .action-btn::after {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transition: 0.5s;
        }

        .action-btn:hover {
            border-color: var(--primary);
            background: #1a1d29;
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .action-btn:hover::after { left: 100%; }

        .action-btn.hero {
            background: var(--primary);
            border: none;
            font-weight: 900;
            box-shadow: 0 0 30px var(--primary-glow);
        }

        .social-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .social-link {
            width: 50px; height: 50px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--cell-border);
            display: flex;
            justify-content: center; align-items: center;
            color: #fff; font-size: 1.2rem;
            text-decoration: none;
            transition: var(--trans-norm);
        }

        .social-link:hover {
            background: var(--primary);
            color: #fff;
            transform: rotate(-10deg) translateY(-5px);
            box-shadow: 0 5px 15px var(--primary-glow);
        }

        /* ================================================================
           4. –ò–ì–†–û–í–û–ô –ú–û–î–£–õ–¨ (GAMEPLAY)
           ================================================================
        */
        .game-top-bar {
            width: 95%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 15px 25px;
            border-radius: 20px;
            border: 1px solid var(--cell-border);
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .stat-block { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 0.65rem; text-transform: uppercase; color: var(--text-dim); margin-bottom: 4px; letter-spacing: 1px; }
        .stat-value { font-family: var(--font-mono); font-size: 1.8rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        #board-frame {
            background: var(--bg-board);
            padding: 12px;
            border-radius: 18px;
            border: 2px solid var(--cell-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
        }

        #game-grid {
            display: grid;
            gap: 4px;
        }

        .game-cell {
            width: 42px; height: 42px;
            background: var(--cell-idle);
            border: 1px solid var(--cell-border);
            border-radius: 6px;
            display: flex;
            justify-content: center; align-items: center;
            font-weight: 900; font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s;
            position: relative;
        }

        .game-cell:hover:not(.is-revealed) {
            background: var(--cell-hover);
            transform: scale(1.08);
            border-color: var(--primary);
            z-index: 5;
            box-shadow: 0 0 15px rgba(var(--primary-glow), 0.3);
        }

        .game-cell.is-revealed {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.03);
            cursor: default;
        }

        .game-cell.is-mine {
            background: var(--primary) !important;
            color: #fff;
            box-shadow: 0 0 20px var(--primary);
            animation: boomShake 0.4s ease-in-out;
        }

        @keyframes boomShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }

        .game-cell.is-flagged::after {
            content: 'üö©';
            font-size: 1.1rem;
            filter: drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }

        /* –¶–≤–µ—Ç–∞ —Ü–∏—Ñ—Ä */
        .n-1 { color: #3498db; } .n-2 { color: #2ecc71; } .n-3 { color: #e74c3c; }
        .n-4 { color: #9b59b6; } .n-5 { color: #f1c40f; } .n-6 { color: #1abc9c; }

        /* ================================================================
           5. –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –ò –í–ò–î–ï–û (MODALS)
           ================================================================
        */
        .modal-wrap {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.4s;
        }
        .modal-wrap.visible { display: flex; opacity: 1; }

        .modal-body {
            background: var(--bg-card);
            border: 1px solid var(--primary);
            width: 90%; max-width: 420px;
            padding: 35px; border-radius: 24px;
            text-align: center;
            box-shadow: 0 0 60px rgba(0,0,0,1), 0 0 20px var(--primary-glow);
        }

        #shorts-player-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000;
            display: none; flex-direction: column;
        }
        #shorts-player-view.visible { display: flex; }

        .player-controls {
            padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center;
            background: #0a0a0a; border-bottom: 1px solid #222;
        }

        .timer-badge {
            background: var(--primary);
            color: #fff; padding: 6px 14px; border-radius: 8px;
            font-family: var(--font-mono); font-weight: 700;
        }

        iframe#yt-frame { width: 100%; flex-grow: 1; border: none; }

        /* ================================================================
           6. –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
           ================================================================
        */
        @media (max-width: 480px) {
            .game-cell { width: 35px; height: 35px; font-size: 1rem; }
            .main-logo { font-size: 3.8rem; }
            .brand-sub { font-size: 0.65rem; letter-spacing: 6px; }
            .action-btn { padding: 16px 20px; font-size: 0.9rem; }
        }
    </style>
</head>
<body data-theme="neon">

    <canvas id="particle-canvas"></canvas>

    <div id="app-root">
        
        <section id="menu-screen" class="screen active">
            <div class="logo-group">
                <h1 class="main-logo">Sapper</h1>
                <div class="brand-sub">ALI_GOOD_GAMING</div>
            </div>

            <div class="social-bar">
                <a href="https://youtube.com/@ali-gg" target="_blank" class="social-link"><i class="fab fa-youtube"></i></a>
                <a href="https://t.me/aligoodgaming" target="_blank" class="social-link"><i class="fab fa-telegram"></i></a>
                <a href="https://tiktok.com/@ali_goodgaming" target="_blank" class="social-link"><i class="fab fa-tiktok"></i></a>
            </div>

            <nav class="menu-grid">
                <button class="action-btn hero" onclick="Engine.launchGame()">
                    <i class="fas fa-play-circle"></i> <span data-i18n="play">–ò–≥—Ä–∞—Ç—å</span>
                </button>
                <button class="action-btn" onclick="UI.openSettings()">
                    <i class="fas fa-sliders-h"></i> <span data-i18n="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </button>
                <button class="action-btn" onclick="UI.openRecords()">
                    <i class="fas fa-award"></i> <span data-i18n="records">–†–µ–∫–æ—Ä–¥—ã</span>
                </button>
            </nav>
        </section>

        <section id="game-screen" class="screen">
            <header class="game-top-bar">
                <div class="stat-block">
                    <div class="stat-label" data-i18n="mines">–ú–∏–Ω—ã</div>
                    <div id="mine-display" class="stat-value">üí£ 010</div>
                </div>

                <div id="restart-trigger" class="action-btn" style="width: 55px; height: 55px; border-radius: 50%; padding: 0;" onclick="GameCore.reset()">
                    <i class="fas fa-sync-alt" style="color: var(--primary);"></i>
                </div>

                <div class="stat-block">
                    <div class="stat-label" data-i18n="time">–í—Ä–µ–º—è</div>
                    <div id="time-display" class="stat-value">‚è≥ 00:00</div>
                </div>
            </header>

            <div id="board-frame">
                <div id="game-grid"></div>
            </div>

            <footer style="margin-top: 30px; display: flex; gap: 15px; width: 90%; max-width: 500px;">
                <button class="action-btn" style="flex: 1;" onclick="GameCore.requestHint()">
                    <i class="fas fa-lightbulb"></i> <span data-i18n="hint">–•–∏–Ω—Ç</span>
                </button>
                <button class="action-btn" style="flex: 1;" onclick="Engine.exitToMenu()">
                    <i class="fas fa-door-open"></i> <span data-i18n="menu">–í—ã—Ö–æ–¥</span>
                </button>
            </footer>
        </section>

    </div>

    <div id="global-modal" class="modal-wrap">
        <div class="modal-body">
            <h2 id="modal-title" style="font-family: var(--font-display); color: var(--primary); margin-bottom: 20px; font-size: 1.8rem;">MESSAGE</h2>
            <div id="modal-html-content" style="color: var(--text-dim); line-height: 1.6; margin-bottom: 25px;"></div>
            <button class="action-btn hero" style="width: 100%;" onclick="UI.closeModal()">OK</button>
        </div>
    </div>

    <div id="shorts-player-view">
        <div class="player-controls">
            <div style="font-family: var(--font-display); font-size: 0.8rem; color: var(--primary);">EXCLUSIVE HINT CONTENT</div>
            <div id="video-countdown" class="timer-badge">15s</div>
            <div onclick="VideoGuard.close()" style="cursor: pointer; font-size: 1.6rem; color: #fff;"><i class="fas fa-times-circle"></i></div>
        </div>
        <iframe id="yt-frame" src=""></iframe>
    </div>

<script>
/**
 * ========================================================================
 * 1. CONFIGURATION & LOCALIZATION
 * ========================================================================
 */
const CONFIG = {
    RU: {
        play: "–ò–≥—Ä–∞—Ç—å", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", records: "–†–µ–∫–æ—Ä–¥—ã",
        mines: "–ú–∏–Ω—ã", time: "–í—Ä–µ–º—è", hint: "–ü–æ–º–æ—â—å", menu: "–ú–µ–Ω—é",
        win: "–ü–û–ë–ï–î–ê! üéâ", lose: "–ë–£–ú! üíÄ", easy: "–õ–µ–≥–∫–æ", med: "–°—Ä–µ–¥–Ω–µ", hard: "–≠–∫—Å–ø–µ—Ä—Ç",
        unlocked: "–•–∏–Ω—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!", watching: "–°–º–æ—Ç—Ä–∏: "
    },
    EN: {
        play: "Play", settings: "Settings", records: "Records",
        mines: "Mines", time: "Time", hint: "Hint", menu: "Menu",
        win: "VICTORY! üéâ", lose: "BOOM! üíÄ", easy: "Easy", med: "Medium", hard: "Expert",
        unlocked: "Hint Unlocked!", watching: "Watch: "
    }
};

const SHORTS_LIBRARY = [
    "z0yLX-BKyQo", "YDCA39Ns8vo", "qxuAyYfXtRA", "Np20JpunLJY", "zwhkYTpjt3A",
    "t0Q2otsqC4I", "Sqj1d8I4qH4", "v33-kGj7A7M", "5hS9M2lRToA", "XJ7p9F4M_7Y",
    "eG_FqK8-0W8", "X_y59fA8W_M"
];

/**
 * ========================================================================
 * 2. BACKGROUND ENGINE (PARTICLES)
 * ========================================================================
 */
const Particles = {
    canvas: document.getElementById('particle-canvas'),
    ctx: null,
    dots: [],
    mouse: { x: -100, y: -100 },

    init() {
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('mousemove', (e) => {
            this.mouse.x = e.clientX;
            this.mouse.y = e.clientY;
        });

        for(let i=0; i<85; i++) {
            this.dots.push({
                x: Math.random() * this.canvas.width,
                y: Math.random() * this.canvas.height,
                vx: (Math.random() - 0.5) * 0.4,
                vy: (Math.random() - 0.5) * 0.4,
                r: Math.random() * 2 + 0.5
            });
        }
        this.animate();
    },

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    animate() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        const color = getComputedStyle(document.documentElement).getPropertyValue('--primary');

        this.dots.forEach(d => {
            // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –º—ã—à—å—é (–ü—Ä–∏—Ç—è–∂–µ–Ω–∏–µ)
            let dx = this.mouse.x - d.x;
            let dy = this.mouse.y - d.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            if(dist < 180) {
                d.x += dx * 0.012;
                d.y += dy * 0.012;
            }

            d.x += d.vx;
            d.y += d.vy;

            // –û—Ç—Å–∫–æ–∫–∏ –æ—Ç —Å—Ç–µ–Ω
            if(d.x < 0 || d.x > this.canvas.width) d.vx *= -1;
            if(d.y < 0 || d.y > this.canvas.height) d.vy *= -1;

            this.ctx.beginPath();
            this.ctx.arc(d.x, d.y, d.r, 0, Math.PI*2);
            this.ctx.fillStyle = color;
            this.ctx.globalAlpha = 0.25;
            this.ctx.fill();
        });

        // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π
        for(let i=0; i<this.dots.length; i++) {
            for(let j=i+1; j<this.dots.length; j++) {
                let d2 = Math.sqrt((this.dots[i].x - this.dots[j].x)**2 + (this.dots[i].y - this.dots[j].y)**2);
                if(d2 < 110) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.dots[i].x, this.dots[i].y);
                    this.ctx.lineTo(this.dots[j].x, this.dots[j].y);
                    this.ctx.strokeStyle = color;
                    this.ctx.globalAlpha = (1 - (d2/110)) * 0.2;
                    this.ctx.lineWidth = 0.6;
                    this.ctx.stroke();
                }
            }
        }
        requestAnimationFrame(() => this.animate());
    }
};

/**
 * ========================================================================
 * 3. AUDIO ENGINE (WEB AUDIO API)
 * ========================================================================
 */
const Sfx = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    
    play(freq, type, dur, vol = 0.1) {
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.start();
        osc.stop(this.ctx.currentTime + dur);
    },

    tap() { this.play(550, 'sine', 0.1, 0.05); },
    pop() { this.play(900, 'sine', 0.04, 0.03); },
    explosion() { this.play(80, 'sawtooth', 0.7, 0.2); },
    success() { 
        this.play(523.25, 'sine', 0.15); 
        setTimeout(() => this.play(659.25, 'sine', 0.3), 100); 
    }
};

/**
 * ========================================================================
 * 4. GAME CORE LOGIC (SAPPER)
 * ========================================================================
 */
const GameCore = {
    rows: 9, cols: 9, mines: 10,
    matrix: [],
    active: false,
    firstMove: true,
    timerId: null,
    sec: 0,
    flagsCount: 0,
    hintReady: true,
    shuffleVids: [],

    reset() {
        const d = Engine.difficulty;
        const setup = { easy: [9,9,10], med: [12,12,25], hard: [16,16,45] }[d];
        [this.rows, this.cols, this.mines] = setup;

        this.matrix = [];
        this.active = true;
        this.firstMove = true;
        this.sec = 0;
        this.flagsCount = 0;
        clearInterval(this.timerId);
        
        // –†–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ–π –∏–≥—Ä–µ (Fisher-Yates)
        this.shuffleVids = [...SHORTS_LIBRARY];
        for(let i = this.shuffleVids.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [this.shuffleVids[i], this.shuffleVids[j]] = [this.shuffleVids[j], this.shuffleVids[i]];
        }

        this.updateHUD();
        this.buildGrid();
    },

    buildGrid() {
        const container = document.getElementById('game-grid');
        container.innerHTML = '';
        container.style.gridTemplateColumns = `repeat(${this.cols}, 1fr)`;

        for(let r=0; r<this.rows; r++) {
            this.matrix[r] = [];
            for(let c=0; c<this.cols; c++) {
                const cellEl = document.createElement('div');
                cellEl.className = 'game-cell';
                
                cellEl.onclick = () => this.reveal(r, c);
                cellEl.oncontextmenu = (e) => { e.preventDefault(); this.toggleFlag(r, c); };
                
                container.appendChild(cellEl);
                this.matrix[r][c] = { 
                    isMine: false, 
                    isRevealed: false, 
                    isFlagged: false, 
                    neighborMines: 0, 
                    el: cellEl 
                };
            }
        }
    },

    reveal(r, c) {
        if(!this.active || this.matrix[r][c].isFlagged) return;

        if(this.firstMove) {
            this.firstMove = false;
            this.generateMines(r, c);
            this.startTimer();
        }

        this.cascadeOpen(r, c);
    },

    /**
     * –í–û–õ–ù–û–í–ê–Ø (–ö–ê–°–ö–ê–î–ù–ê–Ø) –ê–ù–ò–ú–ê–¶–ò–Ø –û–¢–ö–†–´–¢–ò–Ø
     * depth –≤–ª–∏—è–µ—Ç –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫—É (—á–µ–º –¥–∞–ª—å—à–µ –æ—Ç –∫–ª–∏–∫–∞ - —Ç–µ–º –ø–æ–∑–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è)
     */
    async cascadeOpen(r, c, depth = 0) {
        if(r < 0 || r >= this.rows || c < 0 || c >= this.cols) return;
        const cell = this.matrix[r][c];
        if(cell.isRevealed || cell.isFlagged) return;

        // –≠—Ñ—Ñ–µ–∫—Ç –≤–æ–ª–Ω—ã —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
        if(depth > 0) {
            await new Promise(resolve => setTimeout(resolve, depth * 35));
        }

        cell.isRevealed = true;
        cell.el.classList.add('is-revealed');
        Sfx.pop();

        if(cell.isMine) {
            this.endGame(false);
            return;
        }

        if(cell.neighborMines > 0) {
            cell.el.textContent = cell.neighborMines;
            cell.el.classList.add('n-' + Math.min(cell.neighborMines, 6));
        } else {
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ —Å–æ—Å–µ–¥–µ–π
            for(let dr=-1; dr<=1; dr++) {
                for(let dc=-1; dc<=1; dc++) {
                    if(dr === 0 && dc === 0) continue;
                    this.cascadeOpen(r + dr, c + dc, depth + 1);
                }
            }
        }
        this.verifyVictory();
    },

    generateMines(safeR, safeC) {
        let placed = 0;
        while(placed < this.mines) {
            let rr = Math.floor(Math.random() * this.rows);
            let cc = Math.floor(Math.random() * this.cols);
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø—É—Å—Ç–æ—Ç—É –≤–æ–∫—Ä—É–≥ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
            const isSafeZone = Math.abs(rr - safeR) <= 1 && Math.abs(cc - safeC) <= 1;
            
            if(!this.matrix[rr][cc].isMine && !isSafeZone) {
                this.matrix[rr][cc].isMine = true;
                placed++;
            }
        }

        // –†–∞—Å—á–µ—Ç —Ü–∏—Ñ—Ä
        for(let r=0; r<this.rows; r++) {
            for(let c=0; c<this.cols; c++) {
                if(this.matrix[r][c].isMine) continue;
                let count = 0;
                for(let i=-1; i<=1; i++) {
                    for(let j=-1; j<=1; j++) {
                        if(this.matrix[r+i] && this.matrix[r+i][c+j] && this.matrix[r+i][c+j].isMine) count++;
                    }
                }
                this.matrix[r][c].neighborMines = count;
            }
        }
    },

    toggleFlag(r, c) {
        if(!this.active || this.matrix[r][c].isRevealed) return;
        const cell = this.matrix[r][c];
        
        cell.isFlagged = !cell.isFlagged;
        cell.el.classList.toggle('is-flagged');
        this.flagsCount += cell.isFlagged ? 1 : -1;
        
        Sfx.tap();
        this.updateHUD();
    },

    updateHUD() {
        // –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–ª–∞–≥–æ–≤
        const diff = this.mines - this.flagsCount;
        const displayVal = diff < 0 
            ? "-" + Math.abs(diff).toString().padStart(2, '0') 
            : diff.toString().padStart(3, '0');
        
        document.getElementById('mine-display').textContent = "üí£ " + displayVal;
    },

    startTimer() {
        this.timerId = setInterval(() => {
            this.sec++;
            const m = Math.floor(this.sec / 60).toString().padStart(2, '0');
            const s = (this.sec % 60).toString().padStart(2, '0');
            document.getElementById('time-display').textContent = `‚è≥ ${m}:${s}`;
        }, 1000);
    },

    verifyVictory() {
        const closedCount = this.matrix.flat().filter(c => !c.isRevealed).length;
        if(closedCount === this.mines) this.endGame(true);
    },

    endGame(win) {
        this.active = false;
        clearInterval(this.timerId);
        
        // –í—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–∏–Ω—ã
        this.matrix.flat().forEach(c => {
            if(c.isMine) {
                c.el.classList.add('is-mine');
                c.el.innerHTML = '<i class="fas fa-bomb"></i>';
            }
        });

        if(win) {
            Sfx.success();
            UI.showModal(CONFIG[Engine.lang].win, `Time: ${this.sec}s`);
        } else {
            Sfx.explosion();
            UI.showModal(CONFIG[Engine.lang].lose, "Better luck next time!");
        }
    },

    /**
     * –ú–û–î–£–õ–¨ –ü–û–î–°–ö–ê–ó–û–ö –ò –ó–ê–©–ò–¢–´ –í–ò–î–ï–û
     */
    requestHint() {
        if(!this.active) return;

        if(this.hintReady) {
            this.giveHint();
            this.hintReady = false;
        } else {
            VideoGuard.start();
        }
    },

    giveHint() {
        const safeCells = this.matrix.flat().filter(c => !c.isMine && !c.isRevealed);
        if(safeCells.length) {
            const target = safeCells[Math.floor(Math.random() * safeCells.length)];
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–ª–µ—Ç–∫–∏
            target.el.style.boxShadow = "0 0 25px #fff, inset 0 0 15px var(--primary)";
            target.el.style.borderColor = "#fff";
            setTimeout(() => {
                target.el.style.boxShadow = "";
                target.el.style.borderColor = "";
            }, 2500);
        }
    }
};

/**
 * ========================================================================
 * 5. VIDEO GUARD MODULE (YT SHORTS TRACKER)
 * ========================================================================
 */
const VideoGuard = {
    interval: null,
    isUnlocked: false,

    start() {
        const vidList = GameCore.shuffleVids;
        const randomID = vidList[Math.floor(Math.random() * vidList.length)];
        
        const frame = document.getElementById('yt-frame');
        frame.src = `https://www.youtube.com/embed/${randomID}?autoplay=1&controls=0&modestbranding=1&rel=0`;
        
        document.getElementById('shorts-player-view').classList.add('visible');
        
        let countdown = 15;
        const badge = document.getElementById('video-countdown');
        badge.textContent = countdown + "s";
        badge.style.background = "var(--primary)";

        this.interval = setInterval(() => {
            countdown--;
            badge.textContent = countdown + "s";
            
            if(countdown <= 0) {
                clearInterval(this.interval);
                badge.textContent = "HINT READY";
                badge.style.background = "#00ff88";
                this.isUnlocked = true;
            }
        }, 1000);
    },

    close() {
        clearInterval(this.interval);
        document.getElementById('shorts-player-view').classList.remove('visible');
        document.getElementById('yt-frame').src = "";
        
        if(this.isUnlocked) {
            GameCore.giveHint();
            this.isUnlocked = false;
        }
    }
};

/**
 * ========================================================================
 * 6. UI & APPLICATION ENGINE
 * ========================================================================
 */
const Engine = {
    lang: 'RU',
    difficulty: 'easy',
    theme: 'neon',

    init() {
        Particles.init();
        this.applyStrings();
    },

    launchGame() {
        this.switchScreen('game');
        GameCore.reset();
    },

    exitToMenu() {
        this.switchScreen('menu');
        clearInterval(GameCore.timerId);
    },

    switchScreen(id) {
        Sfx.tap();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id + '-screen').classList.add('active');
    },

    applyStrings() {
        const dict = CONFIG[this.lang];
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = dict[el.dataset.i18n];
        });
    }
};

const UI = {
    showModal(title, html) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-html-content').innerHTML = html;
        document.getElementById('global-modal').classList.add('visible');
    },

    closeModal() {
        document.getElementById('global-modal').classList.remove('visible');
    },

    openSettings() {
        this.showModal(CONFIG[Engine.lang].settings, `
            <div style="display: flex; flex-direction: column; gap: 12px; text-align: left;">
                <label style="font-size: 0.7rem; color: var(--primary);">LANGUAGE</label>
                <select onchange="Engine.lang=this.value; Engine.applyStrings(); UI.closeModal(); UI.openSettings();" style="width:100%; padding:12px; background:#222; border:1px solid #444; color:#fff; border-radius:10px;">
                    <option value="RU" ${Engine.lang==='RU'?'selected':''}>–†–£–°–°–ö–ò–ô</option>
                    <option value="EN" ${Engine.lang==='EN'?'selected':''}>ENGLISH</option>
                </select>

                <label style="font-size: 0.7rem; color: var(--primary); margin-top: 10px;">DIFFICULTY</label>
                <select onchange="Engine.difficulty=this.value" style="width:100%; padding:12px; background:#222; border:1px solid #444; color:#fff; border-radius:10px;">
                    <option value="easy">${CONFIG[Engine.lang].easy}</option>
                    <option value="med">${CONFIG[Engine.lang].med}</option>
                    <option value="hard">${CONFIG[Engine.lang].hard}</option>
                </select>

                <label style="font-size: 0.7rem; color: var(--primary); margin-top: 10px;">COLOR THEME</label>
                <select onchange="document.body.setAttribute('data-theme', this.value)" style="width:100%; padding:12px; background:#222; border:1px solid #444; color:#fff; border-radius:10px;">
                    <option value="neon">CYBER NEON</option>
                    <option value="ocean">DEEP OCEAN</option>
                    <option value="emerald">EMERALD</option>
                    <option value="gold">GOLDEN LUSTRE</option>
                    <option value="blood">BLOOD MOON</option>
                </select>
            </div>
        `);
    },

    openRecords() {
        this.showModal(CONFIG[Engine.lang].records, "<p style='font-family: var(--font-mono);'>No local records found yet.</p>");
    }
};

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
window.onload = () => Engine.init();

</script>
</body>
</html>
