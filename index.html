<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ALI_GOOD_GAMING | Sapper Ultimate Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Montserrat:wght@100;300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           CSS VARIABLES & THEMES ENGINE
           ========================================
        */
        :root {
            /* Theme: Cyber Neon (Default) */
            --primary: #e94560;
            --primary-rgb: 233, 69, 96;
            --secondary: #0f3460;
            --bg-body: #05060f;
            --bg-card: rgba(15, 52, 96, 0.15);
            --text-main: #ffffff;
            --text-dim: rgba(255, 255, 255, 0.6);
            --cell-unsolved: rgba(255, 255, 255, 0.08);
            --cell-solved: rgba(255, 255, 255, 0.02);
            --font-display: 'Orbitron', sans-serif;
            --font-main: 'Montserrat', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --glow: 0 0 15px rgba(233, 69, 96, 0.4);
        }

        [data-theme="ocean"] {
            --primary: #00d2ff; --primary-rgb: 0, 210, 255;
            --secondary: #00334e; --bg-body: #01080e;
            --glow: 0 0 15px rgba(0, 210, 255, 0.4);
        }
        [data-theme="forest"] {
            --primary: #2ecc71; --primary-rgb: 46, 204, 113;
            --secondary: #1b4d3e; --bg-body: #0a110d;
            --glow: 0 0 15px rgba(46, 204, 113, 0.4);
        }
        [data-theme="gold"] {
            --primary: #f1c40f; --primary-rgb: 241, 196, 15;
            --secondary: #3d3000; --bg-body: #0d0b01;
            --glow: 0 0 15px rgba(241, 196, 15, 0.4);
        }
        [data-theme="blood"] {
            --primary: #8e44ad; --primary-rgb: 142, 68, 173;
            --secondary: #2c003e; --bg-body: #09010a;
            --glow: 0 0 15px rgba(142, 68, 173, 0.4);
        }

        /* ========================================
           BASE STYLES
           ========================================
        */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.8s ease;
        }

        #canvas-particles {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #app-container {
            position: relative;
            z-index: 10;
            width: 100%;
            max-width: 1000px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        /* ========================================
           SCREENS & ANIMATIONS
           ========================================
        */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px;
            backface-visibility: hidden;
        }

        .screen.active {
            display: flex;
            animation: screenAppear 0.8s forwards cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes screenAppear {
            from { opacity: 0; transform: scale(0.9) rotateX(10deg); }
            to { opacity: 1; transform: scale(1) rotateX(0); }
        }

        /* Cascade Animation Logic */
        .cascade { opacity: 0; transform: translateY(40px); }
        .active .cascade { animation: cascadeIn 0.7s forwards; }
        .active .c-1 { animation-delay: 0.1s; }
        .active .c-2 { animation-delay: 0.2s; }
        .active .c-3 { animation-delay: 0.3s; }
        .active .c-4 { animation-delay: 0.4s; }
        .active .c-5 { animation-delay: 0.5s; }

        @keyframes cascadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           UI ELEMENTS (BUTTONS, TEXT)
           ========================================
        */
        .main-title {
            font-family: var(--font-display);
            font-size: clamp(3rem, 15vw, 6rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: -2px;
            background: linear-gradient(to bottom, #fff 30%, var(--primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 30px rgba(var(--primary-rgb), 0.5));
            margin-bottom: 0;
        }

        .brand-subtitle {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            letter-spacing: 10px;
            color: var(--primary);
            margin-bottom: 40px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .social-container {
            display: flex;
            gap: 20px;
            margin-bottom: 50px;
        }

        .social-btn {
            width: 60px;
            height: 60px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.6rem;
            text-decoration: none;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .social-btn:hover {
            background: var(--primary);
            transform: translateY(-8px) rotate(10deg);
            box-shadow: var(--glow);
        }

        .menu-btn {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            color: #fff;
            width: 320px;
            padding: 22px;
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            border-radius: 20px;
            cursor: pointer;
            margin: 12px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            backdrop-filter: blur(20px);
        }

        .menu-btn:hover {
            border-color: var(--primary);
            background: rgba(var(--primary-rgb), 0.1);
            transform: translateX(10px);
            box-shadow: inset 0 0 20px rgba(var(--primary-rgb), 0.2);
        }

        .menu-btn.primary {
            background: var(--primary);
            border: none;
        }

        .menu-btn.primary:hover {
            background: #fff;
            color: var(--primary);
            transform: scale(1.05);
        }

        /* ========================================
           GAME INTERFACE (HUD & GRID)
           ========================================
        */
        .game-hud {
            width: 100%;
            max-width: 500px;
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 30px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(30px);
        }

        .hud-stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 5px;
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .reset-trigger {
            width: 65px;
            height: 65px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--glow);
            transition: 0.5s;
        }

        .reset-trigger:hover {
            transform: rotate(360deg) scale(1.1);
        }

        #game-view {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        #minefield {
            display: grid;
            gap: 5px;
            margin: 0 auto;
        }

        .cell {
            width: 40px;
            height: 40px;
            background: var(--cell-unsolved);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .cell:hover:not(.is-revealed) {
            background: rgba(var(--primary-rgb), 0.2);
            border-color: var(--primary);
            transform: translateY(-2px);
            z-index: 5;
        }

        .cell.is-revealed {
            background: var(--cell-solved);
            border-color: transparent;
            cursor: default;
        }

        .cell.is-mine {
            background: var(--primary) !important;
            color: white;
            box-shadow: 0 0 25px var(--primary);
        }

        .cell.is-flagged::after {
            content: '\f024';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: #f1c40f;
            font-size: 0.9rem;
        }

        /* Number Colors */
        .n-1 { color: #3498db; }
        .n-2 { color: #2ecc71; }
        .n-3 { color: #e74c3c; }
        .n-4 { color: #9b59b6; }
        .n-5 { color: #f39c12; }

        /* ========================================
           MODALS & OVERLAYS
           ========================================
        */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(25px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: 0.5s;
        }

        .modal-overlay.is-active {
            display: flex;
            opacity: 1;
        }

        .modal-window {
            background: var(--bg-card);
            border: 1px solid var(--primary);
            width: 90%;
            max-width: 500px;
            border-radius: 40px;
            padding: 40px;
            text-align: center;
            position: relative;
            box-shadow: 0 0 100px rgba(var(--primary-rgb), 0.1);
        }

        .modal-title {
            font-family: var(--font-display);
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 2rem;
        }

        .input-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 0.7rem;
            margin-bottom: 10px;
            letter-spacing: 2px;
            color: var(--text-dim);
        }

        select, input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            padding: 15px;
            color: #fff;
            border-radius: 12px;
            outline: none;
            font-family: var(--font-main);
        }

        /* ========================================
           YOUTUBE MODAL (SPECIAL)
           ========================================
        */
        #youtube-wrapper {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2000;
            display: none;
            background: #000;
        }

        #youtube-wrapper.is-active { display: block; }

        .yt-close {
            position: absolute;
            top: 20px; right: 20px;
            width: 50px; height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            justify-content: center; align-items: center;
            color: white; z-index: 100; cursor: pointer;
        }

        iframe#yt-frame {
            width: 100%; height: 100%; border: none;
        }

        @media (max-width: 600px) {
            .cell { width: 32px; height: 32px; font-size: 0.9rem; }
            .menu-btn { width: 280px; }
        }
    </style>
</head>
<body data-theme="neon">

    <canvas id="canvas-particles"></canvas>

    <div id="app-container">
        
        <section id="screen-home" class="screen active">
            <h1 class="main-title cascade c-1">Sapper</h1>
            <div class="brand-subtitle cascade c-2">ALI_GOOD_GAMING</div>

            <div class="social-container cascade c-3">
                <a href="https://youtube.com/@ali-gg" target="_blank" class="social-btn"><i class="fab fa-youtube"></i></a>
                <a href="https://t.me/aligoodgaming" target="_blank" class="social-btn"><i class="fab fa-telegram"></i></a>
                <a href="https://www.tiktok.com/@ali_goodgaming" target="_blank" class="social-btn"><i class="fab fa-tiktok"></i></a>
            </div>

            <button class="menu-btn primary cascade c-4" onclick="GameApp.navigate('game')">
                <i class="fas fa-play"></i> <span data-i18n="play">–ò–ì–†–ê–¢–¨</span>
            </button>
            <button class="menu-btn cascade c-5" onclick="GameApp.openSettings()">
                <i class="fas fa-sliders-h"></i> <span data-i18n="settings">–ù–ê–°–¢–†–û–ô–ö–ò</span>
            </button>
            <button class="menu-btn cascade c-6" onclick="GameApp.openRecords()">
                <i class="fas fa-crown"></i> <span data-i18n="records">–†–ï–ö–û–†–î–´</span>
            </button>
        </section>

        <section id="screen-game" class="screen">
            <div class="game-hud cascade c-1">
                <div class="hud-stat">
                    <div class="stat-label" data-i18n="mines_label">–ú–ò–ù–´</div>
                    <div id="hud-mines" class="stat-value">010</div>
                </div>

                <div class="reset-trigger" onclick="GameEngine.init()">
                    <i class="fas fa-redo"></i>
                </div>

                <div class="hud-stat">
                    <div class="stat-label" data-i18n="time_label">–í–†–ï–ú–Ø</div>
                    <div id="hud-timer" class="stat-value">00:00</div>
                </div>
            </div>

            <div id="game-view" class="cascade c-2">
                <div id="minefield"></div>
            </div>

            <div style="margin-top: 30px; display: flex; gap: 15px;" class="cascade c-3">
                <button class="menu-btn" style="width: 160px; margin: 0;" onclick="GameEngine.requestHint()">
                    <i class="fas fa-lightbulb"></i> <span data-i18n="hint">–•–ò–ù–¢</span>
                </button>
                <button class="menu-btn" style="width: 160px; margin: 0;" onclick="GameApp.navigate('home')">
                    <i class="fas fa-door-open"></i> <span data-i18n="exit">–í–´–•–û–î</span>
                </button>
            </div>
        </section>
    </div>

    <div id="system-modal" class="modal-overlay">
        <div class="modal-window">
            <h2 id="modal-head" class="modal-title">Settings</h2>
            <div id="modal-content"></div>
            <button class="menu-btn primary" style="width: 100%; margin: 20px 0 0 0;" onclick="GameApp.closeModal()">OK</button>
        </div>
    </div>

    <div id="youtube-wrapper">
        <div class="yt-close" onclick="GameApp.closeShorts()"><i class="fas fa-times"></i></div>
        <iframe id="yt-frame" src="" allow="autoplay"></iframe>
    </div>

<script>
/**
 * ============================================================
 * CONFIGURATION & LOCALIZATION
 * ============================================================
 */
const LANGUAGES = {
    ru: {
        play: "–ò–ì–†–ê–¢–¨", settings: "–ù–ê–°–¢–†–û–ô–ö–ò", records: "–†–ï–ö–û–†–î–´",
        exit: "–í–´–•–û–î", hint: "–ü–û–ú–û–©–¨", mines_label: "–ú–ò–ù–´",
        time_label: "–í–†–ï–ú–Ø", lang_select: "–Ø–ó–´–ö –ò–ù–¢–ï–†–§–ï–ô–°–ê",
        theme_select: "–í–ò–ó–£–ê–õ–¨–ù–ê–Ø –¢–ï–ú–ê", diff_select: "–°–õ–û–ñ–ù–û–°–¢–¨",
        win_msg: "–í–´–î–ê–Æ–©–ê–Ø–°–Ø –ü–û–ë–ï–î–ê! üéâ", lose_msg: "–û–ë–ù–ê–†–£–ñ–ï–ù–ê –ú–ò–ù–ê. –ö–û–ù–ï–¶ –ò–ì–†–´ üíÄ",
        easy: "–õ–ï–ì–ö–û", med: "–°–†–ï–î–ù–ï", hard: "–≠–ö–°–ü–ï–†–¢"
    },
    en: {
        play: "PLAY NOW", settings: "SETTINGS", records: "RECORDS",
        exit: "EXIT", hint: "HINT", mines_label: "MINES",
        time_label: "TIME", lang_select: "INTERFACE LANGUAGE",
        theme_select: "VISUAL THEME", diff_select: "DIFFICULTY",
        win_msg: "OUTSTANDING VICTORY! üéâ", lose_msg: "MINE DETECTED. GAME OVER üíÄ",
        easy: "EASY", med: "NORMAL", hard: "EXPERT"
    }
};

const SHORTS_DATABASE = [
    "z0yLX-BKyQo", "YDCA39Ns8vo", "qxuAyYfXtRA", "Np20JpunLJY", "zwhkYTpjt3A"
];

/**
 * ============================================================
 * SOUND PROCESSOR
 * ============================================================
 */
class SoundEngine {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.enabled = true;
    }

    play(freq, type, duration, volume = 0.1) {
        if (!this.enabled) return;
        if (this.ctx.state === 'suspended') this.ctx.resume();

        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        gain.gain.setValueAtTime(volume, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + duration);

        osc.connect(gain);
        gain.connect(this.ctx.destination);

        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    }

    tap() { this.play(500, 'sine', 0.1); }
    reveal() { this.play(800, 'sine', 0.05, 0.05); }
    flag() { this.play(300, 'triangle', 0.2); }
    boom() { this.play(60, 'sawtooth', 0.8, 0.3); }
    win() {
        this.play(523, 'sine', 0.3);
        setTimeout(() => this.play(659, 'sine', 0.3), 150);
        setTimeout(() => this.play(783, 'sine', 0.5), 300);
    }
}

const Audio = new SoundEngine();

/**
 * ============================================================
 * VISUAL EFFECTS (PARTICLES)
 * ============================================================
 */
const Visuals = {
    canvas: document.getElementById('canvas-particles'),
    ctx: null,
    dots: [],
    
    init() {
        this.ctx = this.canvas.getContext('2d');
        window.addEventListener('resize', () => this.resize());
        this.resize();
        this.createDots();
        this.animate();
    },

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    },

    createDots() {
        for(let i=0; i<60; i++) {
            this.dots.push({
                x: Math.random() * this.canvas.width,
                y: Math.random() * this.canvas.height,
                vx: (Math.random() - 0.5) * 0.4,
                vy: (Math.random() - 0.5) * 0.4,
                size: Math.random() * 2
            });
        }
    },

    animate() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        const color = getComputedStyle(document.documentElement).getPropertyValue('--primary');
        
        this.dots.forEach(d => {
            d.x += d.vx; d.y += d.vy;
            if(d.x < 0 || d.x > this.canvas.width) d.vx *= -1;
            if(d.y < 0 || d.y > this.canvas.height) d.vy *= -1;

            this.ctx.globalAlpha = 0.3;
            this.ctx.fillStyle = color;
            this.ctx.beginPath();
            this.ctx.arc(d.x, d.y, d.size, 0, Math.PI*2);
            this.ctx.fill();

            this.dots.forEach(d2 => {
                let dist = Math.sqrt((d.x-d2.x)**2 + (d.y-d2.y)**2);
                if(dist < 100) {
                    this.ctx.globalAlpha = 1 - (dist / 100);
                    this.ctx.strokeStyle = color;
                    this.ctx.lineWidth = 0.2;
                    this.ctx.beginPath();
                    this.ctx.moveTo(d.x, d.y);
                    this.ctx.lineTo(d2.x, d2.y);
                    this.ctx.stroke();
                }
            });
        });
        requestAnimationFrame(() => this.animate());
    }
};

/**
 * ============================================================
 * GAME ENGINE CORE
 * ============================================================
 */
const GameEngine = {
    state: {
        difficulty: 'easy',
        rows: 9, cols: 9, mines: 10,
        grid: [],
        active: false,
        firstTap: true,
        seconds: 0,
        timer: null,
        flags: 0,
        hints: 0
    },

    levels: {
        easy: { r: 9, c: 9, m: 10 },
        medium: { r: 12, c: 12, m: 25 },
        hard: { r: 16, c: 16, m: 45 }
    },

    init() {
        const conf = this.levels[this.state.difficulty];
        this.state.rows = conf.r;
        this.state.cols = conf.c;
        this.state.mines = conf.m;
        this.state.grid = [];
        this.state.active = true;
        this.state.firstTap = true;
        this.state.seconds = 0;
        this.state.flags = 0;
        this.state.hints = 0;

        clearInterval(this.state.timer);
        this.updateHUD();
        this.buildGrid();
    },

    buildGrid() {
        const field = document.getElementById('minefield');
        field.innerHTML = '';
        field.style.gridTemplateColumns = `repeat(${this.state.cols}, 1fr)`;
        
        for(let r=0; r<this.state.rows; r++) {
            this.state.grid[r] = [];
            for(let c=0; c<this.state.cols; c++) {
                const el = document.createElement('div');
                el.className = 'cell';
                el.onclick = () => this.handleCell(r, c);
                el.oncontextmenu = (e) => { e.preventDefault(); this.handleFlag(r, c); };
                
                field.appendChild(el);
                this.state.grid[r][c] = {
                    mine: false, revealed: false, flag: false, n: 0, el: el
                };
            }
        }
    },

    handleCell(r, c) {
        if(!this.state.active) return;
        const cell = this.state.grid[r][c];
        if(cell.flag || cell.revealed) return;

        if(this.state.firstTap) {
            this.state.firstTap = false;
            this.plantMines(r, c);
            this.startTimer();
        }

        this.reveal(r, c);
    },

    // –¢–ê –°–ê–ú–ê–Ø –ü–û–°–¢–ï–ü–ï–ù–ù–ê–Ø –ê–ù–ò–ú–ê–¶–ò–Ø
    async reveal(r, c, delay = 0) {
        if(r<0 || r>=this.state.rows || c<0 || c>=this.state.cols) return;
        const cell = this.state.grid[r][c];
        if(cell.revealed || cell.flag) return;

        if(delay > 0) await new Promise(res => setTimeout(res, delay));

        cell.revealed = true;
        cell.el.classList.add('is-revealed');
        Audio.reveal();

        if(cell.mine) {
            this.endGame(false);
            return;
        }

        if(cell.n > 0) {
            cell.el.textContent = cell.n;
            cell.el.classList.add('n-' + Math.min(cell.n, 5));
        } else {
            const neighbors = [
                [r-1,c-1],[r-1,c],[r-1,c+1],
                [r,c-1],          [r,c+1],
                [r+1,c-1],[r+1,c],[r+1,c+1]
            ];
            neighbors.forEach(([nr, nc]) => this.reveal(nr, nc, 40));
        }
        this.checkWin();
    },

    plantMines(exR, exC) {
        let count = 0;
        while(count < this.state.mines) {
            let r = Math.floor(Math.random()*this.state.rows);
            let c = Math.floor(Math.random()*this.state.cols);
            if(!this.state.grid[r][c].mine && (Math.abs(r-exR)>1 || Math.abs(c-exC)>1)) {
                this.state.grid[r][c].mine = true;
                count++;
            }
        }

        for(let r=0; r<this.state.rows; r++) {
            for(let c=0; c<this.state.cols; c++) {
                if(this.state.grid[r][c].mine) continue;
                let n = 0;
                for(let i=-1; i<=1; i++) {
                    for(let j=-1; j<=1; j++) {
                        if(this.state.grid[r+i] && this.state.grid[r+i][c+j] && this.state.grid[r+i][c+j].mine) n++;
                    }
                }
                this.state.grid[r][c].n = n;
            }
        }
    },

    handleFlag(r, c) {
        if(!this.state.active || this.state.grid[r][c].revealed) return;
        const cell = this.state.grid[r][c];
        cell.flag = !cell.flag;
        cell.el.classList.toggle('is-flagged');
        this.state.flags += cell.flag ? 1 : -1;
        Audio.flag();
        this.updateHUD();
    },

    updateHUD() {
        document.getElementById('hud-mines').textContent = String(Math.max(0, this.state.mines - this.state.flags)).padStart(3, '0');
    },

    startTimer() {
        this.state.timer = setInterval(() => {
            this.state.seconds++;
            const m = Math.floor(this.state.seconds/60);
            const s = this.state.seconds%60;
            document.getElementById('hud-timer').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        }, 1000);
    },

    checkWin() {
        const unsolved = this.state.grid.flat().filter(c => !c.revealed).length;
        if(unsolved === this.state.mines) this.endGame(true);
    },

    endGame(win) {
        this.state.active = false;
        clearInterval(this.state.timer);
        
        this.state.grid.flat().forEach(c => {
            if(c.mine) {
                c.el.classList.add('is-mine');
                c.el.innerHTML = '<i class="fas fa-bomb"></i>';
            }
        });

        if(win) {
            Audio.win();
            GameApp.showModal('WIN', LANGUAGES[GameApp.lang].win_msg);
        } else {
            Audio.boom();
            GameApp.showModal('GAMEOVER', LANGUAGES[GameApp.lang].lose_msg);
        }
    },

    requestHint() {
        if(!this.state.active) return;
        if(this.state.hints === 0) {
            this.useHint();
            this.state.hints = 1;
        } else {
            GameApp.openShorts();
        }
    },

    useHint() {
        const safe = this.state.grid.flat().filter(c => !c.mine && !c.revealed);
        if(safe.length) {
            const pick = safe[Math.floor(Math.random()*safe.length)];
            pick.el.style.boxShadow = "inset 0 0 20px #fff, 0 0 20px #fff";
            setTimeout(() => pick.el.style.boxShadow = "", 1500);
        }
    }
};

/**
 * ============================================================
 * APPLICATION CONTROLLER (UI & NAVIGATION)
 * ============================================================
 */
const GameApp = {
    lang: 'ru',
    theme: 'neon',

    init() {
        this.updateUI();
        Visuals.init();
    },

    navigate(screenId) {
        Audio.tap();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + screenId).classList.add('active');
        if(screenId === 'game') GameEngine.init();
    },

    updateUI() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            el.textContent = LANGUAGES[this.lang][el.dataset.i18n];
        });
    },

    openSettings() {
        this.showModal(LANGUAGES[this.lang].settings, `
            <div class="input-group">
                <label>${LANGUAGES[this.lang].lang_select}</label>
                <select onchange="GameApp.setLang(this.value)">
                    <option value="ru" ${this.lang==='ru'?'selected':''}>–†–£–°–°–ö–ò–ô</option>
                    <option value="en" ${this.lang==='en'?'selected':''}>ENGLISH</option>
                </select>
            </div>
            <div class="input-group">
                <label>${LANGUAGES[this.lang].theme_select}</label>
                <select onchange="GameApp.setTheme(this.value)">
                    <option value="neon">CYBER NEON</option>
                    <option value="ocean">DEEP OCEAN</option>
                    <option value="forest">EMERALD FOREST</option>
                    <option value="gold">LUXURY GOLD</option>
                    <option value="blood">BLOOD MOON</option>
                </select>
            </div>
            <div class="input-group">
                <label>${LANGUAGES[this.lang].diff_select}</label>
                <select onchange="GameEngine.state.difficulty=this.value; GameEngine.init()">
                    <option value="easy">${LANGUAGES[this.lang].easy}</option>
                    <option value="medium">${LANGUAGES[this.lang].med}</option>
                    <option value="hard">${LANGUAGES[this.lang].hard}</option>
                </select>
            </div>
        `);
    },

    setLang(v) { this.lang = v; this.updateUI(); this.closeModal(); this.openSettings(); },
    setTheme(v) { document.body.setAttribute('data-theme', v); },

    showModal(title, content) {
        document.getElementById('modal-head').textContent = title;
        document.getElementById('modal-content').innerHTML = content;
        document.getElementById('system-modal').classList.add('is-active');
    },

    closeModal() { document.getElementById('system-modal').classList.remove('is-active'); },

    openShorts() {
        const id = SHORTS_DATABASE[Math.floor(Math.random()*SHORTS_DATABASE.length)];
        document.getElementById('yt-frame').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
        document.getElementById('youtube-wrapper').classList.add('is-active');
    },

    closeShorts() {
        document.getElementById('youtube-wrapper').classList.remove('is-active');
        document.getElementById('yt-frame').src = "";
        GameEngine.state.hints = 0;
        GameEngine.useHint();
    },

    openRecords() {
        this.showModal(LANGUAGES[this.lang].records, "<p style='opacity:0.5'>–¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ –ø—É—Å—Ç–∞...</p>");
    }
};

// Start application
window.onload = () => GameApp.init();
</script>
</body>
</html>
